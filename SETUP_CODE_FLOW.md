# Setup Code Flow

## Overview
This flow gates first-time onboarding behind a one-time setup code generated by Haulio (back team). The setup code is single-use and becomes invalid once an organization is created.

## Generate a setup code (Haulio only)
Run from repo root:

```
pnpm setupcode:create
```

The command prints a new code to the console and stores it in the database.

## Public endpoints
- `GET /setup/status`
  - Returns `{ hasOrg: boolean }`
  - Used by the UI to decide whether to show `/setup` or `/login`.

- `POST /setup/validate`
  - Input: `{ code }`
  - Output: `{ valid: boolean }`
  - Valid when the code exists and has not been consumed.
  - Sets a short-lived httpOnly cookie `setup_code` for the session.

- `POST /setup/consume-and-create-org`
  - Input:
    ```json
    {
      "code": "...",
      "companyName": "...",
      "admin": {
        "name": "...",
        "email": "...",
        "password": "..."
      }
    }
    ```
  - Behavior:
    - Validates an unconsumed setup code
    - Creates the Organization and Admin user
    - Consumes the setup code (sets `consumedAt` and `orgId`)
    - Creates a session + CSRF token

## Required vs optional
Required to create org/admin:
- Company name
- Admin name
- Admin email
- Admin password

Optional (completed later in existing onboarding):
- Operating entities
- Team invites
- Drivers
- Fleet
- Document rules
- Tracking
- Finance defaults

## UI flow
- Before any org exists: `/` redirects to `/setup`.
- `/setup` accepts the setup code, then collects the required company/admin details.
- After org creation, the user is redirected to `/onboarding` (existing flow), and the usual “Complete onboarding” banner continues to be shown until setup is fully complete.

## DB model
`SetupCode` table:
- `code` (unique)
- `orgId` (nullable)
- `consumedAt` (nullable)
- `createdAt`

Codes are single-use. A consumed code is never valid again.
