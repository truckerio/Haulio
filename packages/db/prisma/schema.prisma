generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  DISPATCHER
  HEAD_DISPATCHER
  BILLING
  DRIVER
}

enum LoadAssignmentRole {
  PRIMARY
  CO_DRIVER
}

enum LoadStatus {
  DRAFT
  PLANNED
  ASSIGNED
  IN_TRANSIT
  DELIVERED
  POD_RECEIVED
  READY_TO_INVOICE
  INVOICED
  PAID
  CANCELLED
}

enum StopType {
  PICKUP
  YARD
  DELIVERY
}

enum LegType {
  PICKUP
  LINEHAUL
  DELIVERY
}

enum LegStatus {
  PLANNED
  IN_PROGRESS
  COMPLETE
}

enum ManifestStatus {
  PLANNED
  LOADED
  IN_TRANSIT
  ARRIVED
  UNLOADED
  COMPLETE
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MED
  HIGH
}

enum TaskType {
  COLLECT_POD
  VERIFY_POD
  MISSING_DOC
  STOP_DELAY_FOLLOWUP
  INVOICE_DISPUTE
  PAYMENT_FOLLOWUP
  DRIVER_COMPLIANCE_EXPIRING
  CUSTOMER_CALLBACK
}

enum DocType {
  POD
  RATECON
  RATE_CONFIRMATION
  BOL
  LUMPER
  SCALE
  DETENTION
  ACCESSORIAL_PROOF
  OTHER
}

enum VaultScopeType {
  ORG
  TRUCK
  DRIVER
}

enum VaultDocType {
  INSURANCE
  REGISTRATION
  PERMIT
  CARGO_INSURANCE
  LIABILITY
  IFTA
  TITLE
  OTHER
}

enum DocStatus {
  UPLOADED
  VERIFIED
  REJECTED
}

enum DocSource {
  DRIVER_UPLOAD
  OPS_UPLOAD
  EMAIL_IMPORT
  API
}

enum OnboardingStatus {
  NOT_ACTIVATED
  OPERATIONAL
}

enum LoadConfirmationStatus {
  UPLOADED
  EXTRACTING
  NEEDS_REVIEW
  READY_TO_CREATE
  CREATED
  FAILED
}

enum EventType {
  LOAD_CREATED
  LOAD_ASSIGNED
  LOAD_STATUS_UPDATED
  STOP_ARRIVED
  STOP_DEPARTED
  DOC_UPLOADED
  DOC_VERIFIED
  DOC_REJECTED
  DRIVER_NOTE
  INVOICE_GENERATED
  PACKET_GENERATED
  TASK_CREATED
  TASK_DONE
  SETTLEMENT_GENERATED
  SETTLEMENT_FINALIZED
  SETTLEMENT_PAID
  IMPORT_COMPLETED
}

enum InvoiceStatus {
  GENERATED
  SENT
  ACCEPTED
  DISPUTED
  PAID
  SHORT_PAID
  VOID
}

enum BillingStatus {
  BLOCKED
  READY
  INVOICED
}

enum AccessorialType {
  DETENTION
  LUMPER
  TONU
  REDELIVERY
  STOP_OFF
  OTHER
}

enum AccessorialStatus {
  PROPOSED
  NEEDS_PROOF
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

enum LearningDomain {
  MATCH_CUSTOMER
  MATCH_SHIPPER
  MATCH_CONSIGNEE
  MATCH_ADDRESS
  IMPORT_MAPPING
  CHARGE_SUGGESTION
  ATTENTION_OUTCOME
}

enum OperatingEntityType {
  CARRIER
  BROKER
}

enum LoadType {
  COMPANY
  BROKERED
  VAN
  REEFER
  FLATBED
  OTHER
}

enum LoadBusinessType {
  COMPANY
  BROKER
}

enum TeamEntityType {
  LOAD
  TRUCK
  TRAILER
  DRIVER
}

enum TrackingProviderType {
  PHONE
  SAMSARA
}

enum FuelSummarySource {
  SAMSARA
}

enum TrackingSessionStatus {
  OFF
  ON
  ERROR
  ENDED
}

enum TrackingIntegrationStatus {
  CONNECTED
  DISCONNECTED
}

enum Permission {
  LOAD_CREATE
  LOAD_EDIT
  LOAD_ASSIGN
  STOP_EDIT
  RATE_EDIT
  INVOICE_GENERATE
  INVOICE_SEND
  INVOICE_VOID
  DOC_VERIFY
  TASK_ASSIGN
  ADMIN_SETTINGS
  SETTLEMENT_GENERATE
  SETTLEMENT_FINALIZE
}

enum LoadChargeType {
  LINEHAUL
  LUMPER
  DETENTION
  LAYOVER
  OTHER
  ADJUSTMENT
}

enum DriverDocType {
  CDL
  MED_CARD
  MVR
  W9
  INSURANCE
  OTHER
}

enum StopStatus {
  PLANNED
  ARRIVED
  DEPARTED
  SKIPPED
}

enum DriverStatus {
  AVAILABLE
  ON_LOAD
  UNAVAILABLE
}

enum TruckStatus {
  AVAILABLE
  ASSIGNED
  MAINTENANCE
  OUT_OF_SERVICE
}

enum TrailerStatus {
  AVAILABLE
  ASSIGNED
  MAINTENANCE
  OUT_OF_SERVICE
}

enum TrailerType {
  DRY_VAN
  REEFER
  FLATBED
  OTHER
}

enum DelayReason {
  SHIPPER_DELAY
  RECEIVER_DELAY
  TRAFFIC
  WEATHER
  BREAKDOWN
  OTHER
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
}

enum NotificationEvent {
  TASK_ASSIGNED
  TASK_DUE_SOON
  LOAD_ASSIGNED
  STOP_DELAYED
  POD_MISSING
}

enum OperatingMode {
  CARRIER
  BROKER
  BOTH
}

enum TrackingPreference {
  MANUAL
  SAMSARA
  MOTIVE
  OTHER
}

enum SettlementSchedule {
  WEEKLY
  BIWEEKLY
  SEMI_MONTHLY
  MONTHLY
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  users       User[]
  drivers     Driver[]
  trucks      Truck[]
  trailers    Trailer[]
  customers   Customer[]
  loads       Load[]
  operatingEntities OperatingEntity[]
  stops       Stop[]
  documents   Document[]
  vaultDocuments VaultDocument[]
  loadConfirmationDocuments LoadConfirmationDocument[]
  loadConfirmationExtractEvents LoadConfirmationExtractEvent[]
  loadConfirmationLearningExamples LoadConfirmationLearningExample[]
  learningExamples LearningExample[]
  learnedMappings LearnedMapping[]
  events      Event[]
  tasks       Task[]
  settings    OrgSettings?
  audits      AuditLog[]
  invoices    Invoice[]
  settlements Settlement[]
  loadCharges LoadCharge[]
  accessorials Accessorial[]
  storage     StorageRecord[]
  trackingIntegrations TrackingIntegration[]
  fuelSummaries FuelSummary[]
  truckTelematicsMappings TruckTelematicsMapping[]
  trackingSessions LoadTrackingSession[]
  locationPings LocationPing[]
  legs        LoadLeg[]
  manifests   TrailerManifest[]
  invites     UserInvite[]
  passwordResets PasswordReset[]
  onboardingState OnboardingState?
  sequence   OrgSequence?
  setupCodes SetupCode[]
  teams      Team[]
  teamMembers TeamMember[]
  teamAssignments TeamAssignment[]
  assignmentSuggestionLogs AssignmentSuggestionLog[]
  driverStats DriverStats[]
}

model SetupCode {
  id         String   @id @default(cuid())
  code       String   @unique
  orgId      String?
  consumedAt DateTime?
  createdAt  DateTime @default(now())

  org Organization? @relation(fields: [orgId], references: [id])

  @@index([consumedAt])
}

model OrgSequence {
  id             String   @id @default(cuid())
  orgId          String   @unique
  nextLoadNumber Int      @default(1001)
  nextTripNumber Int      @default(1001)
  loadPrefix     String   @default("LD-") @db.VarChar(10)
  tripPrefix     String   @default("TR-") @db.VarChar(10)
  updatedAt      DateTime @updatedAt

  org Organization @relation(fields: [orgId], references: [id])
}

model Team {
  id        String   @id @default(cuid())
  orgId     String
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org         Organization  @relation(fields: [orgId], references: [id])
  defaultUsers User[]       @relation("UserDefaultTeam")
  members     TeamMember[]
  assignments TeamAssignment[]

  @@unique([orgId, name])
  @@index([orgId])
}

model TeamMember {
  id        String   @id @default(cuid())
  orgId     String
  teamId    String
  userId    String
  createdAt DateTime @default(now())

  org  Organization @relation(fields: [orgId], references: [id])
  team Team         @relation(fields: [teamId], references: [id])
  user User         @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
  @@index([orgId, userId])
}

model TeamAssignment {
  id         String         @id @default(cuid())
  orgId      String
  teamId     String
  entityType TeamEntityType
  entityId   String
  createdAt  DateTime       @default(now())

  org  Organization @relation(fields: [orgId], references: [id])
  team Team         @relation(fields: [teamId], references: [id])

  @@unique([orgId, entityType, entityId])
  @@index([orgId, teamId])
}

model User {
  id           String       @id @default(cuid())
  orgId        String
  email        String       @db.Citext
  passwordHash String
  role         Role
  name         String?
  phone        String?
  profilePhotoUrl String?
  permissions  Permission[] @default([])
  isActive     Boolean      @default(true)
  canSeeAllTeams Boolean    @default(false)
  defaultTeamId String?
  timezone     String?
  lastLoginAt  DateTime?
  createdAt    DateTime     @default(now())

  org               Organization           @relation(fields: [orgId], references: [id])
  defaultTeam       Team?                  @relation("UserDefaultTeam", fields: [defaultTeamId], references: [id])
  sessions          Session[]
  driver            Driver?
  createdLoads      Load[]                 @relation("CreatedLoads")
  deletedLoads      Load[]                 @relation("DeletedLoads")
  events            Event[]
  documents         Document[]             @relation("UploadedDocs")
  vaultDocuments    VaultDocument[]        @relation("VaultUploads")
  verifiedDocs      Document[]             @relation("VerifiedDocs")
  rejectedDocs      Document[]             @relation("RejectedDocs")
  createdAccessorials Accessorial[]        @relation("AccessorialCreatedBy")
  approvedAccessorials Accessorial[]       @relation("AccessorialApprovedBy")
  loadConfirmationDocuments LoadConfirmationDocument[] @relation("LoadConfirmationUploads")
  audits            AuditLog[]
  assignedTasks     Task[]                 @relation("AssignedTasks")
  createdTasks      Task[]                 @relation("CreatedTasks")
  completedTasks    Task[]                 @relation("CompletedTasks")
  trackingSessionsStarted LoadTrackingSession[] @relation("TrackingSessionsStarted")
  notificationPrefs UserNotificationPref[]
  invites           UserInvite[]
  passwordResets    PasswordReset[]
  teamMemberships   TeamMember[]
  assignmentSuggestionLogs AssignmentSuggestionLog[] @relation("AssignmentSuggestionDispatcher")

  @@unique([orgId, email])
}

model UserInvite {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  tokenHash String
  createdAt DateTime @default(now())
  expiresAt DateTime
  usedAt    DateTime?

  org  Organization @relation(fields: [orgId], references: [id])
  user User         @relation(fields: [userId], references: [id])

  @@index([orgId, userId])
  @@unique([tokenHash])
}

model PasswordReset {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  tokenHash String
  createdAt DateTime @default(now())
  expiresAt DateTime
  usedAt    DateTime?

  org  Organization @relation(fields: [orgId], references: [id])
  user User         @relation(fields: [userId], references: [id])

  @@index([orgId, userId])
  @@unique([tokenHash])
}

model Session {
  id           String    @id @default(cuid())
  userId       String
  tokenHash    String
  createdAt    DateTime  @default(now())
  expiresAt    DateTime
  lastUsedAt   DateTime?
  revokedAt    DateTime?
  revokeReason String?
  ipAddress    String?
  userAgent    String?

  user User @relation(fields: [userId], references: [id])

  @@index([tokenHash])
  @@index([userId, expiresAt])
}

model Driver {
  id               String    @id @default(cuid())
  orgId            String
  userId           String?   @unique
  name             String
  status           DriverStatus @default(AVAILABLE)
  profilePhotoUrl  String?
  phone            String?
  license          String?
  licenseState     String?
  licenseExpiresAt DateTime?
  medCardExpiresAt DateTime?
  payRatePerMile   Decimal?  @db.Decimal(12, 2)
  archivedAt       DateTime?
  createdAt        DateTime  @default(now())

  org        Organization      @relation(fields: [orgId], references: [id])
  user       User?             @relation(fields: [userId], references: [id])
  loads      Load[]            @relation("DriverLoads")
  loadAssignments LoadAssignmentMember[] @relation("DriverLoadAssignments")
  legs       LoadLeg[]
  manifests  TrailerManifest[]
  Task       Task[]
  Settlement Settlement[]
  locationPings LocationPing[]
  stats      DriverStats[]
}

model Truck {
  id        String   @id @default(cuid())
  orgId     String
  unit      String
  vin       String?
  plate     String?
  plateState String?
  status    TruckStatus @default(AVAILABLE)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  org       Organization      @relation(fields: [orgId], references: [id])
  loads     Load[]
  legs      LoadLeg[]
  manifests TrailerManifest[]
  telematicsMappings TruckTelematicsMapping[]
  fuelSummaries FuelSummary[]
  locationPings LocationPing[]

  @@unique([orgId, unit])
  @@unique([orgId, vin])
}

model Trailer {
  id        String   @id @default(cuid())
  orgId     String
  unit      String
  type      TrailerType @default(OTHER)
  plate     String?
  plateState String?
  status    TrailerStatus @default(AVAILABLE)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  org       Organization      @relation(fields: [orgId], references: [id])
  loads     Load[]
  legs      LoadLeg[]
  manifests TrailerManifest[]

  @@unique([orgId, unit])
}

model Load {
  id               String     @id @default(cuid())
  orgId            String
  loadNumber       String
  status           LoadStatus @default(PLANNED)
  loadType         LoadType   @default(COMPANY)
  businessType     LoadBusinessType?
  operatingEntityId String
  customerId       String?
  customerName     String?
  customerRef      String?
  externalTripId   String?    @db.VarChar(64)
  tripNumber       String?    @db.VarChar(64)
  salesRepName     String?    @db.VarChar(128)
  dropName         String?    @db.VarChar(128)
  notes            String?
  desiredInvoiceDate DateTime?
  bolNumber        String?
  shipperReferenceNumber   String?  @db.VarChar(64)
  consigneeReferenceNumber String?  @db.VarChar(64)
  palletCount      Int?
  weightLbs        Int?
  miles            Float?
  rate             Decimal?   @db.Decimal(12, 2)
  assignedDriverId String?
  truckId          String?
  trailerId        String?
  assignedDriverAt DateTime?
  assignedTruckAt  DateTime?
  assignedTrailerAt DateTime?
  plannedAt        DateTime?
  deliveredAt      DateTime?
  podVerifiedAt    DateTime?
  billingStatus    BillingStatus @default(BLOCKED)
  billingBlockingReasons String[] @default([])
  invoicedAt       DateTime?
  externalInvoiceRef String?
  completedAt      DateTime?  @db.Timestamptz(6)
  lockedAt         DateTime?
  createdById      String?
  deletedAt        DateTime?
  deletedById      String?
  deletedReason    String?
  createdAt        DateTime   @default(now())

  org            Organization          @relation(fields: [orgId], references: [id])
  operatingEntity OperatingEntity      @relation(fields: [operatingEntityId], references: [id])
  customer       Customer?             @relation(fields: [customerId], references: [id])
  driver         Driver?               @relation("DriverLoads", fields: [assignedDriverId], references: [id])
  truck          Truck?                @relation(fields: [truckId], references: [id])
  trailer        Trailer?              @relation(fields: [trailerId], references: [id])
  createdBy      User?                 @relation("CreatedLoads", fields: [createdById], references: [id])
  deletedBy      User?                 @relation("DeletedLoads", fields: [deletedById], references: [id])
  stops          Stop[]
  docs           Document[]
  events         Event[]
  assignmentSuggestionLogs AssignmentSuggestionLog[]
  tasks          Task[]
  invoices       Invoice[]
  accessorials   Accessorial[]
  storage        StorageRecord[]
  trackingSessions LoadTrackingSession[]
  locationPings LocationPing[]
  legs           LoadLeg[]
  manifestItems  TrailerManifestItem[]
  SettlementItem SettlementItem[]
  loadConfirmationDocuments LoadConfirmationDocument[]
  charges        LoadCharge[]
  assignmentMembers LoadAssignmentMember[]

  @@unique([orgId, loadNumber])
  @@unique([orgId, tripNumber])
  @@index([orgId, status])
  @@index([orgId, status, createdAt])
  @@index([orgId, completedAt])
  @@index([orgId, status, completedAt])
  @@index([orgId, operatingEntityId])
  @@index([orgId, deletedAt])
}

model LoadAssignmentMember {
  id        String             @id @default(cuid())
  loadId    String
  driverId  String
  role      LoadAssignmentRole
  createdAt DateTime           @default(now())

  load   Load   @relation(fields: [loadId], references: [id])
  driver Driver @relation("DriverLoadAssignments", fields: [driverId], references: [id])

  @@unique([loadId, role])
  @@unique([loadId, driverId])
  @@index([driverId])
}

model LoadCharge {
  id          String         @id @default(cuid())
  orgId       String
  loadId      String
  type        LoadChargeType
  description String?
  amountCents Int
  createdAt   DateTime       @default(now())

  org  Organization @relation(fields: [orgId], references: [id])
  load Load         @relation(fields: [loadId], references: [id])

  @@index([orgId, loadId])
  @@index([loadId])
}

model Accessorial {
  id              String             @id @default(cuid())
  orgId           String
  loadId          String
  type            AccessorialType
  amount          Decimal            @db.Decimal(12, 2)
  currency        String             @default("USD")
  requiresProof   Boolean            @default(false)
  status          AccessorialStatus  @default(PROPOSED)
  notes           String?
  createdById     String?
  approvedById    String?
  approvedAt      DateTime?
  proofDocumentId String?            @unique
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  org          Organization @relation(fields: [orgId], references: [id])
  load         Load         @relation(fields: [loadId], references: [id])
  createdBy    User?        @relation("AccessorialCreatedBy", fields: [createdById], references: [id])
  approvedBy   User?        @relation("AccessorialApprovedBy", fields: [approvedById], references: [id])
  proofDocument Document?   @relation("AccessorialProofDoc", fields: [proofDocumentId], references: [id])

  @@index([orgId, loadId])
  @@index([loadId])
}

model OperatingEntity {
  id        String              @id @default(cuid())
  orgId     String
  name      String
  type      OperatingEntityType
  addressLine1 String?
  addressLine2 String?
  city      String?
  state     String?
  zip       String?
  phone     String?
  email     String?
  mcNumber  String?
  dotNumber String?
  remitToName String?
  remitToAddressLine1 String?
  remitToCity String?
  remitToState String?
  remitToZip String?
  isDefault Boolean            @default(false)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  org   Organization @relation(fields: [orgId], references: [id])
  loads Load[]

  @@index([orgId])
  @@index([orgId, isDefault])
}

model TrackingIntegration {
  id           String                    @id @default(cuid())
  orgId        String
  providerType TrackingProviderType
  status       TrackingIntegrationStatus @default(DISCONNECTED)
  configJson   Json?
  errorMessage String?
  lastFuelSyncAt DateTime?
  lastFuelSyncError String?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt

  org Organization @relation(fields: [orgId], references: [id])

  @@unique([orgId, providerType])
  @@index([orgId, status])
}

model TruckTelematicsMapping {
  id           String                @id @default(cuid())
  orgId        String
  truckId      String
  providerType TrackingProviderType
  externalId   String
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  org   Organization @relation(fields: [orgId], references: [id])
  truck Truck        @relation(fields: [truckId], references: [id])

  @@unique([orgId, providerType, externalId])
  @@unique([orgId, truckId, providerType])
  @@index([orgId, truckId])
}

model FuelSummary {
  id             String             @id @default(cuid())
  orgId          String
  truckId        String
  providerType   TrackingProviderType
  source         FuelSummarySource
  periodStart    DateTime
  periodEnd      DateTime
  periodDays     Int
  fuelUsed       Decimal?           @db.Decimal(12, 2)
  distance       Decimal?           @db.Decimal(12, 2)
  fuelEfficiency Decimal?           @db.Decimal(12, 4)
  lastSyncedAt   DateTime
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  org   Organization @relation(fields: [orgId], references: [id])
  truck Truck        @relation(fields: [truckId], references: [id])

  @@unique([orgId, truckId, providerType, periodStart, periodEnd])
  @@index([orgId, periodStart, periodEnd])
  @@index([orgId, truckId])
}

model LoadTrackingSession {
  id            String                @id @default(cuid())
  orgId         String
  loadId        String
  providerType  TrackingProviderType
  status        TrackingSessionStatus @default(OFF)
  startedByUserId String?
  startedAt     DateTime?
  endedAt       DateTime?

  org           Organization @relation(fields: [orgId], references: [id])
  load          Load         @relation(fields: [loadId], references: [id])
  startedByUser User?        @relation("TrackingSessionsStarted", fields: [startedByUserId], references: [id])

  @@index([orgId, loadId])
}

model LocationPing {
  id          String                @id @default(cuid())
  orgId       String
  loadId      String?
  truckId     String?
  driverId    String?
  providerType TrackingProviderType
  lat         Decimal               @db.Decimal(9, 6)
  lng         Decimal               @db.Decimal(9, 6)
  accuracyM   Float?
  speedMph    Float?
  heading     Float?
  capturedAt  DateTime
  createdAt   DateTime              @default(now())

  org    Organization @relation(fields: [orgId], references: [id])
  load   Load?        @relation(fields: [loadId], references: [id])
  truck  Truck?       @relation(fields: [truckId], references: [id])
  driver Driver?      @relation(fields: [driverId], references: [id])

  @@index([orgId, loadId, capturedAt])
  @@index([orgId, truckId, capturedAt])
}

model LoadLeg {
  id                String    @id @default(cuid())
  orgId             String
  loadId            String
  sequence          Int
  type              LegType
  status            LegStatus @default(PLANNED)
  startStopSequence Int?
  endStopSequence   Int?
  driverId          String?
  truckId           String?
  trailerId         String?
  departedAt        DateTime?
  arrivedAt         DateTime?
  createdAt         DateTime  @default(now())

  org     Organization @relation(fields: [orgId], references: [id])
  load    Load         @relation(fields: [loadId], references: [id])
  driver  Driver?      @relation(fields: [driverId], references: [id])
  truck   Truck?       @relation(fields: [truckId], references: [id])
  trailer Trailer?     @relation(fields: [trailerId], references: [id])
  Event   Event[]

  @@index([loadId, sequence])
}

model Stop {
  id               String       @id @default(cuid())
  orgId            String
  loadId           String
  type             StopType
  status           StopStatus   @default(PLANNED)
  name             String
  address          String
  city             String
  state            String
  zip              String
  phone            String?
  notes            String?
  lat              Float?
  lng              Float?
  appointmentStart DateTime?
  appointmentEnd   DateTime?
  arrivedAt        DateTime?
  departedAt       DateTime?
  delayReason      DelayReason?
  delayNotes       String?
  detentionMinutes Int?
  checkInMethod    String?
  sequence         Int

  load     Load         @relation(fields: [loadId], references: [id])
  org      Organization @relation(fields: [orgId], references: [id])
  Document Document[]
  Event    Event[]
  Task     Task[]

  @@index([loadId, sequence])
}

model TrailerManifest {
  id                 String         @id @default(cuid())
  orgId              String
  trailerId          String
  truckId            String?
  driverId           String?
  status             ManifestStatus @default(PLANNED)
  origin             String?
  destination        String?
  plannedDepartureAt DateTime?
  plannedArrivalAt   DateTime?
  departedAt         DateTime?
  arrivedAt          DateTime?
  createdAt          DateTime       @default(now())

  org     Organization          @relation(fields: [orgId], references: [id])
  trailer Trailer               @relation(fields: [trailerId], references: [id])
  truck   Truck?                @relation(fields: [truckId], references: [id])
  driver  Driver?               @relation(fields: [driverId], references: [id])
  items   TrailerManifestItem[]

  @@index([orgId, status])
}

model TrailerManifestItem {
  id         String @id @default(cuid())
  manifestId String
  loadId     String

  manifest TrailerManifest @relation(fields: [manifestId], references: [id])
  load     Load            @relation(fields: [loadId], references: [id])

  @@unique([manifestId, loadId])
}

model Document {
  id           String    @id @default(cuid())
  orgId        String
  loadId       String
  stopId       String?
  type         DocType
  status       DocStatus @default(UPLOADED)
  source       DocSource @default(DRIVER_UPLOAD)
  filename     String
  originalName String
  mimeType     String
  size         Int
  uploadedById String?
  uploadedAt   DateTime  @default(now())
  verifiedById String?
  verifiedAt   DateTime?
  rejectedById String?
  rejectedAt   DateTime?
  rejectReason String?

  org        Organization @relation(fields: [orgId], references: [id])
  load       Load         @relation(fields: [loadId], references: [id])
  stop       Stop?        @relation(fields: [stopId], references: [id])
  uploadedBy User?        @relation("UploadedDocs", fields: [uploadedById], references: [id])
  verifiedBy User?        @relation("VerifiedDocs", fields: [verifiedById], references: [id])
  rejectedBy User?        @relation("RejectedDocs", fields: [rejectedById], references: [id])
  accessorialProof Accessorial? @relation("AccessorialProofDoc")
  Event      Event[]
  Task       Task[]

  @@index([loadId, type, status], map: "doc_load_type_status_idx")
  @@index([orgId, type, status])
  @@index([stopId])
}

model VaultDocument {
  id              String         @id @default(cuid())
  orgId           String
  scopeType       VaultScopeType
  scopeId         String?
  docType         VaultDocType
  filename        String
  originalName    String
  mimeType        String
  size            Int
  storageKey      String
  expiresAt       DateTime?
  referenceNumber String?
  notes           String?
  uploadedById    String?
  uploadedAt      DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  org        Organization @relation(fields: [orgId], references: [id])
  uploadedBy User?        @relation("VaultUploads", fields: [uploadedById], references: [id])

  @@index([orgId, scopeType, docType])
  @@index([orgId, expiresAt])
}

model LoadConfirmationDocument {
  id               String                 @id @default(cuid())
  orgId            String
  uploadedByUserId String?
  filename         String
  contentType      String
  sizeBytes        Int
  storageKey       String
  sha256           String
  status           LoadConfirmationStatus @default(UPLOADED)
  extractedJson    Json?
  extractedText    String?                @db.Text
  extractedDraft   Json?
  normalizedDraft  Json?
  errorMessage     String?
  createdLoadId    String?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  org        Organization @relation(fields: [orgId], references: [id])
  uploadedBy User?        @relation("LoadConfirmationUploads", fields: [uploadedByUserId], references: [id])
  createdLoad Load?       @relation(fields: [createdLoadId], references: [id])
  extractEvents LoadConfirmationExtractEvent[]
  learningExamples LoadConfirmationLearningExample[]

  @@index([orgId, sha256])
  @@index([orgId, status])
}

model LoadConfirmationLearningExample {
  id             String   @id @default(cuid())
  orgId          String
  docId          String?
  docFingerprint String?
  brokerName     String?
  extractedText  String?  @db.Text
  extractedDraft Json?
  correctedDraft Json
  sizeBytes      Int
  createdAt      DateTime @default(now())

  org Organization @relation(fields: [orgId], references: [id])
  doc LoadConfirmationDocument? @relation(fields: [docId], references: [id])

  @@index([orgId, createdAt])
  @@index([orgId, docFingerprint])
  @@index([orgId, brokerName])
}

model LearningExample {
  id            String        @id @default(cuid())
  orgId         String
  domain        LearningDomain
  inputJson     Json
  correctedJson Json
  contextJson   Json?
  createdAt     DateTime      @default(now())

  org Organization @relation(fields: [orgId], references: [id])

  @@index([orgId, domain, createdAt])
}

model LearnedMapping {
  id         String        @id @default(cuid())
  orgId      String
  domain     LearningDomain
  key        String
  valueJson  Json
  count      Int           @default(1)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  org Organization @relation(fields: [orgId], references: [id])

  @@unique([orgId, domain, key])
  @@index([orgId, domain, updatedAt])
}

model LoadConfirmationExtractEvent {
  id        String   @id @default(cuid())
  orgId     String
  docId     String
  type      String
  message   String
  createdAt DateTime @default(now())

  org Organization              @relation(fields: [orgId], references: [id])
  doc LoadConfirmationDocument  @relation(fields: [docId], references: [id])

  @@index([orgId, docId])
  @@index([orgId, createdAt])
}

model Event {
  id         String    @id @default(cuid())
  orgId      String
  loadId     String?
  stopId     String?
  legId      String?
  docId      String?
  taskId     String?
  invoiceId  String?
  customerId String?
  userId     String?
  type       EventType
  message    String
  meta       Json?
  createdAt  DateTime  @default(now())

  org      Organization @relation(fields: [orgId], references: [id])
  load     Load?        @relation(fields: [loadId], references: [id])
  stop     Stop?        @relation(fields: [stopId], references: [id])
  leg      LoadLeg?     @relation(fields: [legId], references: [id])
  doc      Document?    @relation(fields: [docId], references: [id])
  task     Task?        @relation(fields: [taskId], references: [id])
  invoice  Invoice?     @relation(fields: [invoiceId], references: [id])
  customer Customer?    @relation(fields: [customerId], references: [id])
  user     User?        @relation(fields: [userId], references: [id])

  @@index([orgId, createdAt])
  @@index([loadId, createdAt])
  @@index([stopId, createdAt])
}

model AssignmentSuggestionLog {
  id              String   @id @default(cuid())
  orgId           String
  loadId          String
  dispatcherUserId String
  createdAt       DateTime @default(now())
  modelVersion    String
  weightsVersion  String?
  suggestionsJson Json
  chosenDriverId  String?
  chosenTruckId   String?
  overrideReason  String?
  overrideNotes   String?

  org        Organization @relation(fields: [orgId], references: [id])
  load       Load         @relation(fields: [loadId], references: [id])
  dispatcher User         @relation("AssignmentSuggestionDispatcher", fields: [dispatcherUserId], references: [id])

  @@index([orgId, createdAt])
  @@index([orgId, loadId, createdAt])
  @@index([orgId, dispatcherUserId, createdAt])
}

model DriverStats {
  id               String   @id @default(cuid())
  orgId            String
  driverId         String
  windowDays       Int
  onTimeRate       Float?
  cancellationRate Float?
  issueRate        Float?
  avgDwellMinutes  Float?
  updatedAt        DateTime @updatedAt

  org    Organization @relation(fields: [orgId], references: [id])
  driver Driver       @relation(fields: [driverId], references: [id])

  @@unique([orgId, driverId, windowDays])
  @@index([orgId, updatedAt])
}

model Task {
  id            String       @id @default(cuid())
  orgId         String
  loadId        String?
  stopId        String?
  docId         String?
  driverId      String?
  invoiceId     String?
  customerId    String?
  dedupeKey     String?
  type          TaskType
  title         String
  status        TaskStatus   @default(OPEN)
  priority      TaskPriority @default(MED)
  dueAt         DateTime?
  assignedRole  Role?
  assignedToId  String?
  createdAt     DateTime     @default(now())
  completedAt   DateTime?
  createdById   String?
  completedById String?

  org         Organization @relation(fields: [orgId], references: [id])
  load        Load?        @relation(fields: [loadId], references: [id])
  stop        Stop?        @relation(fields: [stopId], references: [id])
  doc         Document?    @relation(fields: [docId], references: [id])
  driver      Driver?      @relation(fields: [driverId], references: [id])
  invoice     Invoice?     @relation(fields: [invoiceId], references: [id])
  customer    Customer?    @relation(fields: [customerId], references: [id])
  assignedTo  User?        @relation("AssignedTasks", fields: [assignedToId], references: [id])
  createdBy   User?        @relation("CreatedTasks", fields: [createdById], references: [id])
  completedBy User?        @relation("CompletedTasks", fields: [completedById], references: [id])
  Event       Event[]

  @@unique([orgId, dedupeKey])
  @@index([orgId, status])
  @@index([orgId, status, dueAt])
  @@index([orgId, type])
}

// Deprecated in Ops OS: Yard Storage belongs to Yard OS; retained for backward compatibility.
model StorageRecord {
  id              String    @id @default(cuid())
  orgId           String
  loadId          String?
  checkInAt       DateTime
  checkOutAt      DateTime?
  freeMinutes     Int
  ratePerDay      Decimal   @db.Decimal(12, 2)
  dwellMinutes    Int?
  suggestedCharge Decimal?  @db.Decimal(12, 2)

  org  Organization @relation(fields: [orgId], references: [id])
  load Load?        @relation(fields: [loadId], references: [id])
}

model OrgSettings {
  id                           String          @id @default(cuid())
  orgId                        String          @unique
  companyDisplayName           String
  remitToAddress               String
  currency                     String          @default("USD")
  operatingMode                OperatingMode   @default(CARRIER)
  invoiceTerms                 String
  invoiceTermsDays             Int?
  invoiceFooter                String
  logoUrl                      String?
  invoicePrefix                String
  nextInvoiceNumber            Int
  podRequireSignature          Boolean         @default(true)
  podRequirePrintedName        Boolean         @default(true)
  podRequireDeliveryDate       Boolean         @default(true)
  podMinPages                  Int             @default(1)
  requiredDocs                 DocType[]
  requiredDriverDocs           DriverDocType[]
  collectPodDueMinutes         Int
  missingPodAfterMinutes       Int
  reminderFrequencyMinutes     Int
  requireRateConBeforeDispatch Boolean         @default(false)
  trackingPreference           TrackingPreference @default(MANUAL)
  settlementSchedule           SettlementSchedule @default(WEEKLY)
  settlementTemplate           Json?
  timezone                     String?
  // Deprecated in Ops OS: Yard Storage belongs to Yard OS; retained for backward compatibility.
  freeStorageMinutes           Int
  // Deprecated in Ops OS: Yard Storage belongs to Yard OS; retained for backward compatibility.
  storageRatePerDay            Decimal         @db.Decimal(12, 2)
  pickupFreeDetentionMinutes   Int             @default(120)
  deliveryFreeDetentionMinutes Int             @default(120)
  detentionRatePerHour         Decimal?        @db.Decimal(12, 2)
  driverRatePerMile            Decimal         @default(0.65) @db.Decimal(12, 2)
  createdAt                    DateTime        @default(now())
  updatedAt                    DateTime        @updatedAt

  org Organization @relation(fields: [orgId], references: [id])
}

model Invoice {
  id              String        @id @default(cuid())
  orgId           String
  loadId          String
  invoiceNumber   String
  status          InvoiceStatus @default(GENERATED)
  totalAmount     Decimal?      @db.Decimal(12, 2)
  generatedAt     DateTime      @default(now())
  sentAt          DateTime?
  paidAt          DateTime?
  disputeReason   String?
  disputeNotes    String?
  paymentRef      String?
  shortPaidAmount Decimal?      @db.Decimal(12, 2)
  voidedAt        DateTime?
  pdfPath         String?
  packetPath      String?

  org   Organization      @relation(fields: [orgId], references: [id])
  load  Load              @relation(fields: [loadId], references: [id])
  items InvoiceLineItem[]
  Event Event[]
  Task  Task[]

  @@unique([orgId, invoiceNumber])
}

model InvoiceLineItem {
  id          String   @id @default(cuid())
  invoiceId   String
  code        String
  description String?
  quantity    Decimal? @db.Decimal(12, 2)
  rate        Decimal? @db.Decimal(12, 2)
  amount      Decimal  @db.Decimal(12, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
}

enum SettlementStatus {
  DRAFT
  FINALIZED
  PAID
}

model Settlement {
  id          String           @id @default(cuid())
  orgId       String
  driverId    String
  periodStart DateTime
  periodEnd   DateTime
  status      SettlementStatus @default(DRAFT)
  gross       Decimal?         @db.Decimal(12, 2)
  deductions  Decimal?         @db.Decimal(12, 2)
  net         Decimal?         @db.Decimal(12, 2)
  finalizedAt DateTime?
  paidAt      DateTime?
  createdAt   DateTime         @default(now())

  org    Organization     @relation(fields: [orgId], references: [id])
  driver Driver           @relation(fields: [driverId], references: [id])
  items  SettlementItem[]

  @@unique([orgId, driverId, periodStart, periodEnd])
  @@index([orgId, periodEnd])
}

model SettlementItem {
  id           String  @id @default(cuid())
  settlementId String
  loadId       String?
  code         String
  description  String?
  amount       Decimal @db.Decimal(12, 2)

  settlement Settlement @relation(fields: [settlementId], references: [id])
  load       Load?      @relation(fields: [loadId], references: [id])

  @@index([settlementId])
}

model AuditLog {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  action    String
  entity    String
  entityId  String?
  summary   String
  meta      Json?
  before    Json?
  after     Json?
  createdAt DateTime @default(now())

  org  Organization @relation(fields: [orgId], references: [id])
  user User         @relation(fields: [userId], references: [id])

  @@index([orgId, createdAt])
}

model OnboardingState {
  id             String   @id @default(cuid())
  orgId          String   @unique
  status         OnboardingStatus @default(NOT_ACTIVATED)
  completedSteps Json
  percentComplete Int
  currentStep    Int
  completedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  org Organization @relation(fields: [orgId], references: [id])
}

model UserNotificationPref {
  id      String              @id @default(cuid())
  userId  String
  event   NotificationEvent
  channel NotificationChannel
  enabled Boolean             @default(true)

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, event, channel])
  @@index([userId])
}

model Customer {
  id             String   @id @default(cuid())
  orgId          String
  name           String
  billingEmail   String?
  billingPhone   String?
  remitToAddress String?
  termsDays      Int?
  createdAt      DateTime @default(now())

  org    Organization @relation(fields: [orgId], references: [id])
  loads  Load[]
  tasks  Task[]
  events Event[]

  @@unique([orgId, name])
  @@index([orgId, name])
}
